{% extends "base.html" %}

{% block title %}API文档 - AI对话系统{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="glass-card p-6 mb-6">
        <h1 class="text-2xl font-bold text-white mb-4">API文档</h1>
        <p class="text-gray-300 mb-6">以下是与AI对话系统交互的API接口文档。</p>
        
        <!-- API基础信息 -->
        <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-6">
            <h2 class="text-lg font-semibold text-white mb-2">API基础信息</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <div class="text-gray-400">基础URL:</div>
                    <div class="text-white font-mono">{{ request.base_url }}api</div>
                </div>
                <div>
                    <div class="text-gray-400">数据格式:</div>
                    <div class="text-white">JSON</div>
                </div>
            </div>
        </div>
        
        <!-- API接口列表 -->
        <div class="space-y-6">
            <!-- 对话API -->
            <div class="bg-gray-800 bg-opacity-50 p-5 rounded-lg">
                <h2 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-comments text-blue-400 mr-2"></i>对话接口
                </h2>
                
                <!-- 发送消息 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">发送消息</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">POST</span> <span class="text-yellow-300">/chat</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">请求参数:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "message": "用户消息内容",
  "conversation_id": "可选，对话ID",
  "preset_id": "可选，预设ID",
  "stream": "是否使用流式响应，默认false"
}</code></pre>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">响应示例:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "response": "AI回复内容",
  "conversation_id": "对话ID",
  "timestamp": "2023-11-08T12:00:00"
}</code></pre>
                    </div>
                    
                    <div>
                        <button class="text-blue-400 hover:text-blue-300 text-sm" onclick="tryChatAPI()">
                            <i class="fas fa-play-circle mr-1"></i>在线测试
                        </button>
                    </div>
                </div>
                
                <!-- 获取模型列表 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">获取可用模型</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">GET</span> <span class="text-yellow-300">/models</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">响应示例:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "models": [
    {
      "id": "model-id",
      "name": "model-name"
    }
  ]
}</code></pre>
                    </div>
                    
                    <div>
                        <button class="text-blue-400 hover:text-blue-300 text-sm" onclick="tryModelsAPI()">
                            <i class="fas fa-play-circle mr-1"></i>在线测试
                        </button>
                    </div>
                </div>
                
                <!-- 获取对话历史 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">获取对话历史</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">GET</span> <span class="text-yellow-300">/conversations/{conversation_id}/messages</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">响应示例:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "conversation_id": "对话ID",
  "title": "对话标题",
  "messages": [
    {
      "content": "消息内容",
      "sender": "user或ai",
      "timestamp": "2023-11-08T12:00:00"
    }
  ]
}</code></pre>
                    </div>
                </div>
            </div>
            
            <!-- 预设API -->
            <div class="bg-gray-800 bg-opacity-50 p-5 rounded-lg">
                <h2 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-cog text-purple-400 mr-2"></i>预设接口
                </h2>
                
                <!-- 获取预设列表 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">获取预设列表</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">GET</span> <span class="text-yellow-300">/presets/</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">响应示例:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>[
  {
    "id": 1,
    "name": "预设名称",
    "description": "预设描述",
    "system_prompt": "系统提示",
    "is_active": true,
    "created_at": "2023-11-08T12:00:00",
    "updated_at": "2023-11-08T12:00:00"
  }
]</code></pre>
                    </div>
                    
                    <div>
                        <button class="text-blue-400 hover:text-blue-300 text-sm" onclick="tryPresetsAPI()">
                            <i class="fas fa-play-circle mr-1"></i>在线测试
                        </button>
                    </div>
                </div>
                
                <!-- 创建预设 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">创建预设</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">POST</span> <span class="text-yellow-300">/presets/</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">请求参数:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "name": "预设名称",
  "description": "预设描述",
  "system_prompt": "系统提示",
  "is_active": true
}</code></pre>
                    </div>
                </div>
            </div>
            
            <!-- 对话管理API -->
            <div class="bg-gray-800 bg-opacity-50 p-5 rounded-lg">
                <h2 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-history text-green-400 mr-2"></i>对话管理接口
                </h2>
                
                <!-- 获取对话列表 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">获取对话列表</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">GET</span> <span class="text-yellow-300">/conversations?limit=10&offset=0</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">响应示例:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "conversations": [
    {
      "id": "对话ID",
      "title": "对话标题",
      "created_at": "2023-11-08T12:00:00",
      "updated_at": "2023-11-08T12:00:00"
    }
  ],
  "total": 100,
  "limit": 10,
  "offset": 0
}</code></pre>
                    </div>
                    
                    <div>
                        <button class="text-blue-400 hover:text-blue-300 text-sm" onclick="tryConversationsAPI()">
                            <i class="fas fa-play-circle mr-1"></i>在线测试
                        </button>
                    </div>
                </div>
                
                <!-- 创建新对话 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">创建新对话</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">POST</span> <span class="text-yellow-300">/conversations</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">请求参数:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "title": "对话标题",
  "preset_id": "可选，预设ID"
}</code></pre>
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="mb-6">
                    <h3 class="text-md font-medium text-white mb-2">获取统计信息</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">GET</span> <span class="text-yellow-300">/conversations/statistics</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">响应示例:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "total_conversations": 100,
  "total_messages": 1000,
  "recent_conversations_7_days": 20,
  "oldest_conversation_date": "2023-10-01T12:00:00",
  "max_age_days": 30
}</code></pre>
                    </div>
                </div>
            </div>
            
            <!-- WebSocket API -->
            <div class="bg-gray-800 bg-opacity-50 p-5 rounded-lg">
                <h2 class="text-lg font-semibold text-white mb-4">
                    <i class="fas fa-plug text-orange-400 mr-2"></i>WebSocket接口
                </h2>
                
                <div class="mb-3">
                    <h3 class="text-md font-medium text-white mb-2">实时对话</h3>
                    <div class="bg-gray-900 p-3 rounded mb-2">
                        <span class="text-green-400">WebSocket</span> <span class="text-yellow-300">/ws/{conversation_id}</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">客户端发送消息:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>{
  "message": "用户消息内容",
  "preset_id": "可选，预设ID"
}</code></pre>
                    </div>
                    
                    <div class="mb-3">
                        <div class="text-gray-400 mb-1">服务器响应:</div>
                        <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>// 流式响应
{
  "type": "stream",
  "content": "部分AI回复内容"
}

// 完整消息
{
  "type": "message",
  "sender": "ai",
  "content": "完整AI回复内容"
}

// 错误消息
{
  "type": "error",
  "message": "错误信息"
}</code></pre>
                    </div>
                    
                    <div>
                        <button class="text-blue-400 hover:text-blue-300 text-sm" onclick="showWebSocketExample()">
                            <i class="fas fa-code mr-1"></i>查看示例代码
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API测试模态框 -->
<div id="api-test-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-card p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-semibold text-white">API测试</h2>
            <button id="close-test-modal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <div class="text-gray-400 mb-1">请求URL:</div>
            <div id="request-url" class="bg-gray-900 p-3 rounded text-white font-mono"></div>
        </div>
        
        <div class="mb-4">
            <div class="text-gray-400 mb-1">请求方法:</div>
            <div id="request-method" class="bg-gray-900 p-3 rounded text-white font-mono"></div>
        </div>
        
        <div class="mb-4">
            <label for="request-body" class="text-gray-400 mb-1 block">请求体 (JSON):</label>
            <textarea 
                id="request-body" 
                class="w-full bg-gray-900 text-white p-3 rounded font-mono text-sm resize-none"
                rows="6"></textarea>
        </div>
        
        <div class="mb-4">
            <button id="send-request-btn" class="btn-primary">
                <i class="fas fa-play mr-2"></i>发送请求
            </button>
        </div>
        
        <div class="mb-4">
            <label for="response-body" class="text-gray-400 mb-1 block">响应:</label>
            <textarea 
                id="response-body" 
                class="w-full bg-gray-900 text-white p-3 rounded font-mono text-sm resize-none"
                rows="10" 
                readonly></textarea>
        </div>
    </div>
</div>

<!-- WebSocket示例模态框 -->
<div id="websocket-example-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-card p-6 w-full max-w-4xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-white">WebSocket示例代码</h2>
            <button id="close-ws-modal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <h3 class="text-lg font-medium text-white mb-2">JavaScript示例</h3>
            <pre class="bg-gray-900 p-4 rounded text-sm overflow-x-auto"><code>// 连接WebSocket
const conversationId = 'your-conversation-id';
const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/api/ws/${conversationId}`;
const websocket = new WebSocket(wsUrl);

websocket.onopen = function(event) {
    console.log('WebSocket连接已建立');
};

websocket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    handleMessage(data);
};

websocket.onerror = function(error) {
    console.error('WebSocket错误:', error);
};

// 发送消息
function sendMessage(message, presetId) {
    websocket.send(JSON.stringify({
        message: message,
        preset_id: presetId
    }));
}

// 处理接收到的消息
function handleMessage(data) {
    if (data.type === 'stream') {
        // 流式响应
        updateChatWindow(data.content);
    } else if (data.type === 'message') {
        // 完整消息
        if (data.sender === 'ai') {
            addAiMessage(data.content);
        }
    } else if (data.type === 'error') {
        // 错误消息
        showError(data.message);
    }
}</code></pre>
        </div>
        
        <div class="mb-4">
            <h3 class="text-lg font-medium text-white mb-2">Python示例</h3>
            <pre class="bg-gray-900 p-4 rounded text-sm overflow-x-auto"><code>import asyncio
import websockets
import json

async def chat_with_ai(conversation_id, message):
    uri = f"ws://localhost:8000/ws/{conversation_id}"
    
    async with websockets.connect(uri) as websocket:
        # 发送消息
        await websocket.send(json.dumps({
            "message": message
        }))
        
        # 接收响应
        response = ""
        async for message in websocket:
            data = json.loads(message)
            
            if data["type"] == "stream":
                # 流式响应
                response += data["content"]
                print(data["content"], end="", flush=True)
            elif data["type"] == "message":
                # 完整消息
                if data["sender"] == "ai":
                    print(f"\nAI回复: {data['content']}")
                    break

# 使用示例
asyncio.run(chat_with_ai("your-conversation-id", "你好"))</code></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 显示API测试模态框
    function showApiTestModal(title, method, url, body = '{}') {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('request-method').textContent = method;
        document.getElementById('request-url').textContent = window.location.origin + window.apiBase + url;
        document.getElementById('request-body').value = JSON.stringify(JSON.parse(body), null, 2);
        document.getElementById('response-body').value = '';
        
        document.getElementById('api-test-modal').classList.remove('hidden');
    }
    
    // 隐藏API测试模态框
    function hideApiTestModal() {
        document.getElementById('api-test-modal').classList.add('hidden');
    }
    
    // 发送API请求
    async function sendApiRequest() {
        const method = document.getElementById('request-method').textContent.trim();
        const url = document.getElementById('request-url').textContent.trim();
        const bodyText = document.getElementById('request-body').value.trim();
        const responseTextarea = document.getElementById('response-body');
        
        responseTextarea.value = '请求发送中...';
        
        try {
            let options = {
                method: method
            };
            
            if (bodyText && method !== 'GET') {
                options.body = bodyText;
                options.headers = {
                    'Content-Type': 'application/json'
                };
            }
            
            const response = await fetch(url, options);
            
            let responseData;
            if (response.headers.get('content-type')?.includes('application/json')) {
                responseData = JSON.stringify(await response.json(), null, 2);
            } else {
                responseData = await response.text();
            }
            
            responseTextarea.value = `状态码: ${response.status}\n\n${responseData}`;
        } catch (error) {
            responseTextarea.value = `请求失败: ${error.message}`;
        }
    }
    
    // API测试函数
    function tryChatAPI() {
        showApiTestModal(
            '测试发送消息接口',
            'POST',
            '/chat',
            JSON.stringify({
                message: '你好，请介绍一下你自己',
                conversation_id: null,
                preset_id: null,
                stream: false
            }, null, 2)
        );
    }
    
    function tryModelsAPI() {
        showApiTestModal(
            '测试获取模型列表接口',
            'GET',
            '/models',
            ''
        );
    }
    
    function tryPresetsAPI() {
        showApiTestModal(
            '测试获取预设列表接口',
            'GET',
            '/presets/',
            ''
        );
    }
    
    function tryConversationsAPI() {
        showApiTestModal(
            '测试获取对话列表接口',
            'GET',
            '/conversations?limit=5&offset=0',
            ''
        );
    }
    
    // 显示WebSocket示例
    function showWebSocketExample() {
        document.getElementById('websocket-example-modal').classList.remove('hidden');
    }
    
    // 隐藏WebSocket示例
    function hideWebSocketExample() {
        document.getElementById('websocket-example-modal').classList.add('hidden');
    }
    
    // 事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        // API测试模态框
        document.getElementById('close-test-modal').addEventListener('click', hideApiTestModal);
        document.getElementById('send-request-btn').addEventListener('click', sendApiRequest);
        
        // WebSocket示例模态框
        document.getElementById('close-ws-modal').addEventListener('click', hideWebSocketExample);
        
        // 点击模态框外部关闭
        document.getElementById('api-test-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideApiTestModal();
            }
        });
        
        document.getElementById('websocket-example-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideWebSocketExample();
            }
        });
    });
</script>
{% endblock %}